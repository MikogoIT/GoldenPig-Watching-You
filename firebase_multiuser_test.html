<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase多用户测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-section {
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .test-section h3 {
            margin: 0 0 15px 0;
            color: #333;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .status {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .room-info {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .user-list {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
        }
        
        .user-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
    </style>
    
    <!-- Firebase SDK (v9+ - 现代模块化语法) -->
    <script type="module">
        // 全局Firebase配置和初始化
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, push, remove, update, serverTimestamp, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyBgbodFry-hFl_tiWK9CAYzZ_4FFizc3kE",
            authDomain: "pig-timer-collaboration.firebaseapp.com",
            databaseURL: "https://pig-timer-collaboration-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pig-timer-collaboration",
            storageBucket: "pig-timer-collaboration.firebasestorage.app",
            messagingSenderId: "629352460916",
            appId: "1:629352460916:web:248d4051b64d8cb4e51721",
            measurementId: "G-5RMRLLTTRP"
        };
        
        // 初始化Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        
        // 将Firebase实例暴露给全局作用域
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDatabase = database;
        window.firebaseUtils = {
            signInAnonymously,
            onAuthStateChanged,
            ref,
            set,
            get,
            onValue,
            push,
            remove,
            update,
            serverTimestamp,
            onDisconnect
        };
        
        console.log('✅ Firebase v9+ 初始化完成');
    </script>
</head>
<body>
    <div class="container">
        <h1>🔥 Firebase多用户协作测试</h1>
        
        <div class="test-section">
            <h3>用户身份</h3>
            <div id="user-status" class="status">正在初始化...</div>
            <button onclick="initUser()">初始化用户</button>
        </div>
        
        <div class="test-section">
            <h3>房间操作</h3>
            <button onclick="createRoom()">创建测试房间</button>
            <button onclick="joinRoom()">加入房间</button>
            <button onclick="leaveRoom()">离开房间</button>
            <div id="room-status" class="room-info">暂无房间</div>
        </div>
        
        <div class="test-section">
            <h3>用户列表</h3>
            <div id="users-display" class="user-list">暂无用户</div>
            <button onclick="debugUsers()">调试用户数据</button>
        </div>
        
        <div class="test-section">
            <h3>操作日志</h3>
            <div id="log" class="status" style="height: 200px; overflow-y: auto;"></div>
            <button onclick="clearLog()">清空日志</button>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentRoom = null;
        let usersListener = null;
        
        // 日志函数
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // 初始化用户
        async function initUser() {
            try {
                log('开始用户认证...');
                
                const userCredential = await window.firebaseUtils.signInAnonymously(window.firebaseAuth);
                currentUser = {
                    id: userCredential.user.uid,
                    name: `用户_${Math.random().toString(36).substring(7)}`,
                    color: `#${Math.floor(Math.random()*16777215).toString(16)}`
                };
                
                document.getElementById('user-status').textContent = 
                    `用户ID: ${currentUser.id}\n用户名: ${currentUser.name}\n颜色: ${currentUser.color}`;
                
                log(`✅ 用户认证成功: ${currentUser.name} (${currentUser.id})`);
                
            } catch (error) {
                log(`❌ 用户认证失败: ${error.message}`);
            }
        }
        
        // 创建房间
        async function createRoom() {
            if (!currentUser) {
                log('❌ 请先初始化用户');
                return;
            }
            
            try {
                const roomId = `test_room_${Date.now().toString(36)}`;
                const roomData = {
                    info: {
                        hostId: currentUser.id,
                        hostName: currentUser.name,
                        created: window.firebaseUtils.serverTimestamp(),
                        lastActivity: window.firebaseUtils.serverTimestamp(),
                        isActive: true
                    },
                    users: {
                        [currentUser.id]: {
                            userName: currentUser.name,
                            userColor: currentUser.color,
                            isHost: true,
                            lastSeen: window.firebaseUtils.serverTimestamp(),
                            isOnline: true
                        }
                    }
                };
                
                const roomRef = window.firebaseUtils.ref(window.firebaseDatabase, `rooms/${roomId}`);
                await window.firebaseUtils.set(roomRef, roomData);
                
                currentRoom = roomId;
                
                document.getElementById('room-status').innerHTML = 
                    `房间ID: ${roomId}<br>角色: 房主<br>状态: 活跃`;
                
                // 设置用户监听
                setupUsersListener(roomId);
                
                log(`✅ 房间创建成功: ${roomId}`);
                
            } catch (error) {
                log(`❌ 房间创建失败: ${error.message}`);
            }
        }
        
        // 加入房间
        async function joinRoom() {
            if (!currentUser) {
                log('❌ 请先初始化用户');
                return;
            }
            
            const roomId = prompt('请输入房间ID:');
            if (!roomId) return;
            
            try {
                // 检查房间是否存在
                const roomRef = window.firebaseUtils.ref(window.firebaseDatabase, `rooms/${roomId}`);
                const roomSnapshot = await window.firebaseUtils.get(roomRef);
                
                if (!roomSnapshot.exists()) {
                    log(`❌ 房间不存在: ${roomId}`);
                    return;
                }
                
                // 添加用户到房间
                const userRef = window.firebaseUtils.ref(window.firebaseDatabase, `rooms/${roomId}/users/${currentUser.id}`);
                await window.firebaseUtils.set(userRef, {
                    userName: currentUser.name,
                    userColor: currentUser.color,
                    isHost: false,
                    lastSeen: window.firebaseUtils.serverTimestamp(),
                    isOnline: true
                });
                
                currentRoom = roomId;
                
                document.getElementById('room-status').innerHTML = 
                    `房间ID: ${roomId}<br>角色: 成员<br>状态: 活跃`;
                
                // 设置用户监听
                setupUsersListener(roomId);
                
                log(`✅ 成功加入房间: ${roomId}`);
                
            } catch (error) {
                log(`❌ 加入房间失败: ${error.message}`);
            }
        }
        
        // 离开房间
        async function leaveRoom() {
            if (!currentRoom || !currentUser) {
                log('❌ 没有活跃的房间');
                return;
            }
            
            try {
                // 移除用户
                const userRef = window.firebaseUtils.ref(window.firebaseDatabase, `rooms/${currentRoom}/users/${currentUser.id}`);
                await window.firebaseUtils.remove(userRef);
                
                // 清理监听器
                if (usersListener) {
                    usersListener = null;
                }
                
                document.getElementById('room-status').textContent = '暂无房间';
                document.getElementById('users-display').textContent = '暂无用户';
                
                log(`✅ 已离开房间: ${currentRoom}`);
                currentRoom = null;
                
            } catch (error) {
                log(`❌ 离开房间失败: ${error.message}`);
            }
        }
        
        // 设置用户监听
        function setupUsersListener(roomId) {
            if (usersListener) {
                // 清理旧的监听器
                usersListener = null;
            }
            
            const usersRef = window.firebaseUtils.ref(window.firebaseDatabase, `rooms/${roomId}/users`);
            usersListener = window.firebaseUtils.onValue(usersRef, (snapshot) => {
                const users = snapshot.val();
                log(`🔥 用户数据更新: ${JSON.stringify(users)}`);
                updateUsersDisplay(users);
            });
            
            log(`✅ 用户监听器已设置: ${roomId}`);
        }
        
        // 更新用户显示
        function updateUsersDisplay(users) {
            const usersDiv = document.getElementById('users-display');
            
            if (!users) {
                usersDiv.innerHTML = '暂无用户';
                return;
            }
            
            const userEntries = Object.entries(users);
            const userCount = userEntries.length;
            
            let html = `<strong>用户数: ${userCount}</strong><br>`;
            
            userEntries.forEach(([userId, userData]) => {
                const isCurrentUser = userId === currentUser?.id;
                const userName = userData.userName || '未知用户';
                const userColor = userData.userColor || '#ccc';
                const isHost = userData.isHost ? ' (房主)' : '';
                const isOnline = userData.isOnline ? '在线' : '离线';
                
                html += `
                    <div class="user-item">
                        <div class="user-color" style="background-color: ${userColor}"></div>
                        <span>${userName}${isCurrentUser ? ' (我)' : ''}${isHost}</span>
                        <span style="margin-left: auto; color: ${userData.isOnline ? 'green' : 'red'}">${isOnline}</span>
                    </div>
                `;
            });
            
            usersDiv.innerHTML = html;
        }
        
        // 调试用户数据
        async function debugUsers() {
            if (!currentRoom) {
                log('❌ 没有活跃的房间');
                return;
            }
            
            try {
                const usersRef = window.firebaseUtils.ref(window.firebaseDatabase, `rooms/${currentRoom}/users`);
                const snapshot = await window.firebaseUtils.get(usersRef);
                const users = snapshot.val();
                
                log(`🔍 调试 - 房间 ${currentRoom} 的用户数据:`);
                log(JSON.stringify(users, null, 2));
                
            } catch (error) {
                log(`❌ 调试失败: ${error.message}`);
            }
        }
        
        // 页面加载时自动初始化
        window.addEventListener('load', () => {
            setTimeout(() => {
                initUser();
            }, 1000);
        });
    </script>
</body>
</html>
