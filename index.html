<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>金猪刷新监控系统</title>
    
    <!-- 外部样式文件 -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="css/animations.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>金猪刷新监控系统 <span class="gold-pig">🐷</span></h1>
            <p class="subtitle">监控每条线路的金猪状态，标记击杀后自动开始24小时倒计时</p>
        </header>
        
        <div class="dashboard">
            <div class="controls">
                <div class="panel-title">
                    ℹ️
                    <h2>操作面板 <span class="status-indicator status-active"></span></h2>
                </div>
                
                <div class="instructions">
                    <h3>📖 使用说明</h3>
                    <ul>
                        <li class="desktop-instruction">
                            🖱️
                            <span class="highlight">左键单击线路格子</span> - 标记金猪被击杀（开始24小时倒计时）
                        </li>
                        <li class="desktop-instruction">
                            👆
                            <span class="highlight">右键单击线路格子</span> - 标记金猪被击杀但不知时间
                        </li>
                        <li class="mobile-instruction">
                            📱
                            <span class="highlight">点击线路格子</span> - 标记金猪被击杀（开始24小时倒计时）
                        </li>
                        <li class="mobile-instruction">
                            👆
                            <span class="highlight">快速三连击线路格子</span> - 标记金猪被击杀但不知时间
                        </li>
                        <li>
                            🔄
                            <span class="highlight">双击红色/橙色格子</span> - 取消击杀状态和倒计时
                        </li>
                        <li>
                            🔄
                            倒计时结束后线路自动变为<span class="highlight">绿色</span>可用状态
                        </li>
                        <li>
                            💾
                            所有数据自动保存在浏览器中，关闭浏览器后仍可恢复
                        </li>
                        <li>
                            🕐
                            重新打开浏览器时自动恢复倒计时
                        </li>
                        <li>
                            ⏰
                            <span class="highlight">"只重置倒计时状态"</span> - 清除所有线路标记但保留历史统计
                        </li>
                    </ul>
                </div>
                
                <div class="status-info">
                    <div class="panel-title">
                        🎨
                        <h2>状态说明</h2>
                    </div>
                    <div class="status-item">
                        <div class="status-color status-1"></div>
                        <div>未击杀/可用线路</div>
                    </div>
                    <div class="status-item">
                        <div class="status-color status-2"></div>
                        <div>金猪已被击杀（倒计时中）</div>
                    </div>
                    <div class="status-item">
                        <div class="status-color status-5"></div>
                        <div>金猪已被击杀（时间未知）</div>
                    </div>
                    <div class="status-item">
                        <div class="status-color status-3"></div>
                        <div>金猪已刷新（可再次击杀）</div>
                    </div>
                    <div class="status-item">
                        <div class="status-color status-4"></div>
                        <div>倒计时显示</div>
                    </div>
                </div>
                
                <button class="action-btn reset" onclick="resetAll()">
                    🔄 重置所有状态
                </button>
                
                <button class="action-btn reset-timers" onclick="resetTimersOnly()">
                    ⏰ 只重置倒计时状态
                </button>
                
                <button class="action-btn" onclick="toggleTestMode()" id="test-mode-btn">
                    🔬 开启测试模式（10秒倒计时）
                </button>
                
                <div class="notes-container">
                    <label for="notes-input" class="notes-label">
                        📝 备注记录
                    </label>
                    <textarea 
                        id="notes-input" 
                        class="notes-input"
                        placeholder="在这里记录一些备注信息..."
                    ></textarea>
                </div>
            </div>
            
            <div class="flex-container">
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">金猪击杀统计</div>
                        <div class="chart-tabs">
                            <div class="chart-tab active" data-chart="daily">每日击杀</div>
                            <div class="chart-tab" data-chart="total">总击杀</div>
                            <div class="chart-tab" data-chart="hourly">击杀时段</div>
                        </div>
                    </div>
                    <div class="chart-box">
                        <canvas id="stats-chart" width="800" height="300" style="width: 100%; height: 300px; background: rgba(0,0,0,0.1); border-radius: 8px;"></canvas>
                    </div>
                </div>
                
                <div class="stats">
                    <div class="panel-title">
                        📊
                        <h2>状态统计</h2>
                    </div>
                    
                    <div class="stat-cards">
                        <div class="stat-card">
                            <div class="stat-label">总线路数</div>
                            <div class="stat-value" id="total-lines">400</div>
                            <div class="stat-label">当前可用线路</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">已击杀金猪</div>
                            <div class="stat-value" id="killed-count">0</div>
                            <div class="stat-label">倒计时中</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">击杀未知时间</div>
                            <div class="stat-value" id="killed-unknown-count">0</div>
                            <div class="stat-label">时间未知</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">已刷新线路</div>
                            <div class="stat-value" id="refreshed-count">0</div>
                            <div class="stat-label">可再次击杀</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">可用线路</div>
                            <div class="stat-value" id="available-count">400</div>
                            <div class="stat-label">未击杀状态</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-label">今日击杀</div>
                        <div class="stat-value" id="today-count">0</div>
                        <div class="stat-label">最后24小时</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <div class="scroll-hint">
                ⬅️ 向左滑动查看更多线路 ➡️
            </div>
            <table id="line-table">
                <tr>
                    <th>A</th><th>B</th><th>C</th><th>D</th><th>E</th><th>F</th><th>G</th><th>H</th>
                    <th>I</th><th>J</th><th>K</th><th>L</th><th>M</th><th>N</th><th>O</th><th>P</th>
                    <th>Q</th><th>R</th><th>S</th><th>T</th>
                </tr>
                <!-- 测试行 - 如果JavaScript失败至少显示一些格子 -->
                <tr>
                    <td data-line="1">1<div class="timer-display" id="timer-1"></div></td>
                    <td data-line="2">2<div class="timer-display" id="timer-2"></div></td>
                    <td data-line="3">3<div class="timer-display" id="timer-3"></div></td>
                    <td data-line="4">4<div class="timer-display" id="timer-4"></div></td>
                    <td data-line="5">5<div class="timer-display" id="timer-5"></div></td>
                    <td data-line="6">6<div class="timer-display" id="timer-6"></div></td>
                    <td data-line="7">7<div class="timer-display" id="timer-7"></div></td>
                    <td data-line="8">8<div class="timer-display" id="timer-8"></div></td>
                    <td data-line="9">9<div class="timer-display" id="timer-9"></div></td>
                    <td data-line="10">10<div class="timer-display" id="timer-10"></div></td>
                    <td data-line="11">11<div class="timer-display" id="timer-11"></div></td>
                    <td data-line="12">12<div class="timer-display" id="timer-12"></div></td>
                    <td data-line="13">13<div class="timer-display" id="timer-13"></div></td>
                    <td data-line="14">14<div class="timer-display" id="timer-14"></div></td>
                    <td data-line="15">15<div class="timer-display" id="timer-15"></div></td>
                    <td data-line="16">16<div class="timer-display" id="timer-16"></div></td>
                    <td data-line="17">17<div class="timer-display" id="timer-17"></div></td>
                    <td data-line="18">18<div class="timer-display" id="timer-18"></div></td>
                    <td data-line="19">19<div class="timer-display" id="timer-19"></div></td>
                    <td data-line="20">20<div class="timer-display" id="timer-20"></div></td>
                </tr>
            </table>
        </div>
        
        <footer>
            <p>🔄 系统状态：<span id="status">运行中</span> | 最后更新：<span id="last-update">--:--:--</span></p>
            <p>⚠️ 提示：数据存储在浏览器本地，关闭浏览器后重新打开会恢复倒计时</p>
            <p>👤 制作人：<span class="highlight">Mikogo</span> | 💬 联系QQ：<span class="highlight">1013859513</span></p>
        </footer>
    </div>

    
    <!-- 手机端操作提示 -->
    <div class="mobile-hint">
        点击格子标记击杀，三连击标记不知时间
    </div>

    <!-- 调试信息 -->
    <div style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; z-index: 1000; font-size: 12px;">
        <div>表格状态: <span id="debug-table-status">检查中...</span></div>
        <div>单元格数: <span id="debug-cell-count">0</span></div>
    </div>

    <!-- 主应用模块脚本 -->
    <script type="module" src="js/app.js"></script>
    
    <!-- 表格生成备用脚本 -->
    <script>
        // 备用表格生成器 - 如果模块加载失败则使用此方法
        function generateTableFallback() {
            console.log('使用备用表格生成器');
            const table = document.getElementById('line-table');
            if (!table) return;
            
            const existingCells = table.querySelectorAll('td[data-line]');
            console.log(`现有单元格: ${existingCells.length}`);
            
            if (existingCells.length >= 400) {
                console.log('表格已完整');
                return;
            }
            
            // 为现有单元格绑定基本事件
            existingCells.forEach(cell => {
                if (!cell.onclick) {
                    cell.addEventListener('click', function() {
                        // 尝试使用主应用的事件处理器，如果不存在则使用备用方式
                        if (window.goldPigApp && window.goldPigApp.eventManager) {
                            const mockEvent = { currentTarget: this };
                            window.goldPigApp.eventManager.handleCellClick(mockEvent);
                        } else {
                            handleCellClickFallback(this);
                        }
                    });
                    
                    cell.addEventListener('contextmenu', function(e) {
                        e.preventDefault();
                        if (window.goldPigApp && window.goldPigApp.eventManager) {
                            const mockEvent = { currentTarget: this, preventDefault: () => {} };
                            window.goldPigApp.eventManager.handleCellRightClick(mockEvent);
                        } else {
                            handleCellRightClickFallback(this);
                        }
                    });
                    
                    cell.addEventListener('dblclick', function() {
                        if (window.goldPigApp && window.goldPigApp.eventManager) {
                            const mockEvent = { currentTarget: this };
                            window.goldPigApp.eventManager.handleCellDoubleClick(mockEvent);
                        } else {
                            handleCellDoubleClickFallback(this);
                        }
                    });
                }
            });
            
            // 生成剩余的单元格
            let lineNumber = existingCells.length + 1;
            let currentRow = existingCells.length > 0 ? existingCells[existingCells.length - 1].parentElement : null;
            let cellsInCurrentRow = currentRow ? currentRow.children.length : 0;
            
            for (let i = lineNumber; i <= 400; i++) {
                // 如果需要新行
                if (!currentRow || cellsInCurrentRow >= 20) {
                    currentRow = document.createElement('tr');
                    table.appendChild(currentRow);
                    cellsInCurrentRow = 0;
                }
                
                const cell = document.createElement('td');
                cell.textContent = i;
                cell.dataset.line = i;
                
                // 添加定时器显示元素
                const timerDisplay = document.createElement('div');
                timerDisplay.id = `timer-${i}`;
                timerDisplay.className = 'timer-display';
                cell.appendChild(timerDisplay);
                
                // 绑定事件
                cell.addEventListener('click', function() {
                    // 尝试使用主应用的事件处理器，如果不存在则使用备用方式
                    if (window.goldPigApp && window.goldPigApp.eventManager) {
                        // 创建模拟事件
                        const mockEvent = { currentTarget: this };
                        window.goldPigApp.eventManager.handleCellClick(mockEvent);
                    } else {
                        // 备用处理方式
                        handleCellClickFallback(this);
                    }
                });
                
                cell.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    // 尝试使用主应用的事件处理器
                    if (window.goldPigApp && window.goldPigApp.eventManager) {
                        const mockEvent = { currentTarget: this, preventDefault: () => {} };
                        window.goldPigApp.eventManager.handleCellRightClick(mockEvent);
                    } else {
                        // 备用处理方式
                        handleCellRightClickFallback(this);
                    }
                });
                
                cell.addEventListener('dblclick', function() {
                    // 尝试使用主应用的事件处理器
                    if (window.goldPigApp && window.goldPigApp.eventManager) {
                        const mockEvent = { currentTarget: this };
                        window.goldPigApp.eventManager.handleCellDoubleClick(mockEvent);
                    } else {
                        // 备用处理方式
                        handleCellDoubleClickFallback(this);
                    }
                });
                
                currentRow.appendChild(cell);
                cellsInCurrentRow++;
            }
            
            const finalCells = table.querySelectorAll('td[data-line]');
            console.log(`备用生成器完成，总共 ${finalCells.length} 个单元格`);
            
            // 更新调试信息
            const debugCellCount = document.getElementById('debug-cell-count');
            if (debugCellCount) {
                debugCellCount.textContent = finalCells.length;
            }
            
            const debugTableStatus = document.getElementById('debug-table-status');
            if (debugTableStatus) {
                debugTableStatus.textContent = finalCells.length === 400 ? '✅ 正常' : `⚠️ 不完整(${finalCells.length})`;
            }
        }
        
        // 备用事件处理函数
        function handleCellClickFallback(cell) {
            const lineNumber = cell.dataset.line;
            console.log('备用处理-点击单元格:', lineNumber);
            
            // 如果已经是击杀状态，则忽略
            if (cell.classList.contains('killed') || cell.classList.contains('killed-unknown')) {
                return;
            }
            
            // 移除刷新状态
            if (cell.classList.contains('refreshed')) {
                cell.classList.remove('refreshed');
            }
            
            // 添加击杀状态
            cell.classList.add('killed');
            
            // 记录击杀时间和状态
            const killTime = new Date().getTime();
            localStorage.setItem(`pigTimer_line-${lineNumber}`, 'killed');
            localStorage.setItem(`pigTimer_killTime-${lineNumber}`, killTime);
            
            // 开始倒计时
            startTimerFallback(lineNumber, killTime, cell);
            
            // 更新统计
            updateStatsFallback();
        }
        
        function handleCellRightClickFallback(cell) {
            const lineNumber = cell.dataset.line;
            console.log('备用处理-右击单元格:', lineNumber);
            
            // 如果已经是击杀状态，则忽略
            if (cell.classList.contains('killed') || cell.classList.contains('killed-unknown')) {
                return;
            }
            
            // 移除刷新状态
            if (cell.classList.contains('refreshed')) {
                cell.classList.remove('refreshed');
            }
            
            // 添加击杀未知状态
            cell.classList.add('killed-unknown');
            
            // 记录状态（不记录时间）
            localStorage.setItem(`pigTimer_line-${lineNumber}`, 'killed-unknown');
            
            // 更新统计
            updateStatsFallback();
        }
        
        function handleCellDoubleClickFallback(cell) {
            const lineNumber = cell.dataset.line;
            console.log('备用处理-双击单元格:', lineNumber);
            
            // 移除所有状态
            cell.classList.remove('killed', 'killed-unknown', 'refreshed');
            
            // 清除计时器
            const timerDisplay = document.getElementById(`timer-${lineNumber}`);
            if (timerDisplay) {
                timerDisplay.textContent = '';
            }
            
            // 清除存储
            localStorage.removeItem(`pigTimer_line-${lineNumber}`);
            localStorage.removeItem(`pigTimer_killTime-${lineNumber}`);
            
            // 停止倒计时
            if (window.fallbackTimers && window.fallbackTimers[lineNumber]) {
                clearInterval(window.fallbackTimers[lineNumber]);
                delete window.fallbackTimers[lineNumber];
            }
            
            // 更新统计
            updateStatsFallback();
        }
        
        // 备用倒计时函数
        function startTimerFallback(lineNumber, killTime, cell) {
            if (!window.fallbackTimers) {
                window.fallbackTimers = {};
            }
            
            // 如果已有倒计时，先清除
            if (window.fallbackTimers[lineNumber]) {
                clearInterval(window.fallbackTimers[lineNumber]);
            }
            
            const timerDisplay = document.getElementById(`timer-${lineNumber}`);
            if (!timerDisplay) return;
            
            // 检查测试模式
            const testMode = localStorage.getItem('pigTimer_testMode') === 'true';
            const timerDuration = testMode ? 10000 : (24 * 60 * 60 * 1000); // 10秒或24小时
            
            window.fallbackTimers[lineNumber] = setInterval(() => {
                const currentTime = new Date().getTime();
                const elapsed = currentTime - killTime;
                const remaining = timerDuration - elapsed;
                
                if (remaining <= 0) {
                    // 倒计时结束
                    clearInterval(window.fallbackTimers[lineNumber]);
                    delete window.fallbackTimers[lineNumber];
                    
                    // 设置为刷新状态
                    cell.classList.remove('killed');
                    cell.classList.add('refreshed');
                    timerDisplay.textContent = '';
                    
                    localStorage.setItem(`pigTimer_line-${lineNumber}`, 'refreshed');
                    updateStatsFallback();
                } else {
                    // 显示剩余时间
                    const hours = Math.floor(remaining / (60 * 60 * 1000));
                    const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
                    const seconds = Math.floor((remaining % (60 * 1000)) / 1000);
                    
                    if (testMode) {
                        timerDisplay.textContent = `${seconds}s`;
                    } else {
                        timerDisplay.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                    }
                }
            }, 1000);
        }
        
        // 备用统计更新函数
        function updateStatsFallback() {
            let killedCount = 0;
            let killedUnknownCount = 0;
            let refreshedCount = 0;
            let availableCount = 0;
            
            const cells = document.querySelectorAll('td[data-line]');
            cells.forEach(cell => {
                if (cell.classList.contains('killed')) {
                    killedCount++;
                } else if (cell.classList.contains('killed-unknown')) {
                    killedUnknownCount++;
                } else if (cell.classList.contains('refreshed')) {
                    refreshedCount++;
                } else {
                    availableCount++;
                }
            });
            
            // 更新统计显示
            const elements = {
                'killed-count': killedCount,
                'killed-unknown-count': killedUnknownCount,
                'refreshed-count': refreshedCount,
                'available-count': availableCount,
                'total-lines': cells.length
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
            
            console.log('统计更新:', elements);
        }
        
        // 全局重置函数（备用）
        function resetAll() {
            console.log('执行全局重置');
            const cells = document.querySelectorAll('td[data-line]');
            cells.forEach(cell => {
                cell.classList.remove('killed', 'killed-unknown', 'refreshed');
                const timer = cell.querySelector('.timer-display');
                if (timer) timer.textContent = '';
            });
            
            // 清除所有倒计时
            if (window.fallbackTimers) {
                Object.values(window.fallbackTimers).forEach(timerId => clearInterval(timerId));
                window.fallbackTimers = {};
            }
            
            // 清除本地存储
            for (let i = 1; i <= 400; i++) {
                localStorage.removeItem(`pigTimer_line-${i}`);
                localStorage.removeItem(`pigTimer_killTime-${i}`);
            }
            
            // 更新统计
            updateStatsFallback();
            
            console.log('重置完成');
        }
        
        // 仅重置倒计时状态函数（备用）
        function resetTimersOnly() {
            console.log('执行仅重置倒计时');
            const cells = document.querySelectorAll('td[data-line]');
            cells.forEach(cell => {
                cell.classList.remove('killed', 'killed-unknown', 'refreshed');
                const timer = cell.querySelector('.timer-display');
                if (timer) timer.textContent = '';
            });
            
            // 清除所有倒计时
            if (window.fallbackTimers) {
                Object.values(window.fallbackTimers).forEach(timerId => clearInterval(timerId));
                window.fallbackTimers = {};
            }
            
            // 清除倒计时存储但保留历史
            for (let i = 1; i <= 400; i++) {
                localStorage.removeItem(`pigTimer_line-${i}`);
                localStorage.removeItem(`pigTimer_killTime-${i}`);
            }
            
            // 更新统计
            updateStatsFallback();
            
            console.log('倒计时重置完成');
        }
        
        // 测试模式切换函数（备用）
        function toggleTestMode() {
            console.log('切换测试模式');
            const currentMode = localStorage.getItem('pigTimer_testMode') === 'true';
            const newMode = !currentMode;
            localStorage.setItem('pigTimer_testMode', newMode);
            
            const btn = document.getElementById('test-mode-btn');
            if (btn) {
                btn.textContent = newMode ? '🔬 关闭测试模式' : '🔬 开启测试模式（10秒倒计时）';
            }
            
            console.log('测试模式:', newMode ? '开启' : '关闭');
        }
        
        // 延迟检查并在需要时使用备用生成器
        setTimeout(() => {
            const table = document.getElementById('line-table');
            const cells = table ? table.querySelectorAll('td[data-line]') : [];
            
            console.log(`检查表格状态: ${cells.length} 个单元格`);
            
            if (cells.length < 400) {
                console.log('表格不完整，使用备用生成器');
                generateTableFallback();
                
                // 生成完成后恢复状态
                setTimeout(() => {
                    restoreStateFallback();
                }, 500);
            } else {
                console.log('表格已完整');
                // 如果表格完整但主应用未工作，恢复状态
                setTimeout(() => {
                    if (!window.goldPigApp || !window.goldPigApp.initialized) {
                        console.log('主应用未初始化，使用备用状态恢复');
                        restoreStateFallback();
                    }
                }, 1000);
            }
        }, 3000); // 延迟3秒检查，给主应用足够时间初始化
        
        // 备用状态恢复函数
        function restoreStateFallback() {
            console.log('开始恢复状态');
            const cells = document.querySelectorAll('td[data-line]');
            
            cells.forEach(cell => {
                const lineNumber = cell.dataset.line;
                const savedState = localStorage.getItem(`pigTimer_line-${lineNumber}`);
                const killTime = localStorage.getItem(`pigTimer_killTime-${lineNumber}`);
                
                if (savedState) {
                    if (savedState === 'killed' && killTime) {
                        cell.classList.add('killed');
                        const killTimeNum = parseInt(killTime);
                        const currentTime = new Date().getTime();
                        const testMode = localStorage.getItem('pigTimer_testMode') === 'true';
                        const timerDuration = testMode ? 10000 : (24 * 60 * 60 * 1000);
                        const elapsed = currentTime - killTimeNum;
                        
                        if (elapsed < timerDuration) {
                            // 继续倒计时
                            startTimerFallback(lineNumber, killTimeNum, cell);
                        } else {
                            // 时间已到，设为刷新状态
                            cell.classList.remove('killed');
                            cell.classList.add('refreshed');
                            localStorage.setItem(`pigTimer_line-${lineNumber}`, 'refreshed');
                        }
                    } else if (savedState === 'killed-unknown') {
                        cell.classList.add('killed-unknown');
                    } else if (savedState === 'refreshed') {
                        cell.classList.add('refreshed');
                    }
                }
            });
            
            // 更新统计
            updateStatsFallback();
            console.log('状态恢复完成');
        }
    </script>
    
    <!-- 调试脚本 -->
    <script>
        // 延迟检查表格状态
        setTimeout(() => {
            const table = document.getElementById('line-table');
            const cells = table ? table.querySelectorAll('td[data-line]') : [];
            
            document.getElementById('debug-table-status').textContent = 
                table ? (cells.length > 0 ? '✅ 正常' : '⚠️ 空表格') : '❌ 未找到';
            document.getElementById('debug-cell-count').textContent = cells.length;
            
            if (cells.length === 0) {
                console.error('表格生成失败，检查控制台错误');
            }
        }, 2000);
    </script>
</body>
</html>