<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV导出测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #005999;
        }
        .result-area {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <h1>CSV导出测试页面</h1>
    
    <div class="test-container">
        <h2>1. 创建测试数据</h2>
        <p>首先创建一些测试的击杀记录数据：</p>
        <button class="test-button" onclick="createTestData()">创建测试数据</button>
        <button class="test-button" onclick="clearTestData()">清空测试数据</button>
        <div id="test-data-status" class="status" style="display:none;"></div>
    </div>
    
    <div class="test-container">
        <h2>2. 验证数据格式</h2>
        <p>检查数据是否正确格式化：</p>
        <button class="test-button" onclick="validateData()">验证数据</button>
        <div id="validation-result" class="result-area" style="display:none;"></div>
    </div>
    
    <div class="test-container">
        <h2>3. 调试CSV内容</h2>
        <p>查看生成的CSV内容（不下载）：</p>
        <button class="test-button" onclick="debugCSV()">调试CSV内容</button>
        <div id="csv-debug-result" class="result-area" style="display:none;"></div>
    </div>
    
    <div class="test-container">
        <h2>4. 测试CSV导出</h2>
        <p>实际测试CSV文件导出：</p>
        <button class="test-button" onclick="testCSVExport()">测试CSV导出</button>
        <button class="test-button" onclick="testJSONExport()">测试JSON导出</button>
        <div id="export-status" class="status" style="display:none;"></div>
    </div>
    
    <div class="test-container">
        <h2>5. 浏览器兼容性检查</h2>
        <p>检查浏览器是否支持文件下载功能：</p>
        <button class="test-button" onclick="checkCompatibility()">检查兼容性</button>
        <div id="compatibility-result" class="result-area" style="display:none;"></div>
    </div>

    <script type="module">
        // 简化版的统计管理器，仅用于测试
        class TestStatsManager {
            constructor() {
                this.killEvents = JSON.parse(localStorage.getItem('killEvents')) || [];
            }
            
            addTestData() {
                const now = Date.now();
                const testEvents = [
                    { line: 1, timestamp: now - 3600000 }, // 1小时前
                    { line: 5, timestamp: now - 7200000 }, // 2小时前
                    { line: 10, timestamp: now - 86400000 }, // 1天前
                    { line: 15, timestamp: now - 172800000 }, // 2天前
                    { line: 20, timestamp: now - 259200000 }, // 3天前
                ];
                
                this.killEvents = testEvents;
                localStorage.setItem('killEvents', JSON.stringify(this.killEvents));
                return testEvents.length;
            }
            
            clearData() {
                this.killEvents = [];
                localStorage.removeItem('killEvents');
            }
            
            validateData() {
                const results = {
                    totalEvents: this.killEvents.length,
                    validTimestamps: 0,
                    invalidTimestamps: 0,
                    validLines: 0,
                    invalidLines: 0,
                    sampleEvents: this.killEvents.slice(0, 3)
                };
                
                this.killEvents.forEach(event => {
                    // 检查时间戳
                    if (typeof event.timestamp === 'number' && event.timestamp > 0) {
                        results.validTimestamps++;
                    } else {
                        results.invalidTimestamps++;
                    }
                    
                    // 检查线路号
                    if (typeof event.line === 'number' && event.line > 0 && event.line <= 400) {
                        results.validLines++;
                    } else {
                        results.invalidLines++;
                    }
                });
                
                return results;
            }
            
            generateCSVContent() {
                if (this.killEvents.length === 0) {
                    throw new Error('没有击杀记录可导出');
                }
                
                // 添加BOM头以支持中文显示
                let csvContent = '\uFEFF';
                
                // CSV标题行
                csvContent += '线路号,击杀时间,击杀日期,完整时间戳\\n';
                
                // 按时间排序击杀事件（最新的在前）
                const sortedEvents = this.killEvents.slice().sort((a, b) => b.timestamp - a.timestamp);
                
                // 数据行
                sortedEvents.forEach(event => {
                    const date = new Date(event.timestamp);
                    const year = date.getFullYear();
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const day = date.getDate().toString().padStart(2, '0');
                    const hours = date.getHours().toString().padStart(2, '0');
                    const minutes = date.getMinutes().toString().padStart(2, '0');
                    const seconds = date.getSeconds().toString().padStart(2, '0');
                    
                    const dateStr = `${year}-${month}-${day}`;
                    const timeStr = `${hours}:${minutes}:${seconds}`;
                    const fullTimestamp = date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    
                    csvContent += `${event.line},${timeStr},${dateStr},${fullTimestamp}\\n`;
                });
                
                return csvContent;
            }
            
            exportToCSV() {
                try {
                    const csvContent = this.generateCSVContent();
                    
                    const blob = new Blob([csvContent], { 
                        type: 'text/csv;charset=utf-8' 
                    });
                    
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `测试_金猪击杀记录_${this.formatDateForFilename(new Date())}.csv`;
                    
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    return { success: true, filename: link.download };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
            
            exportToJSON() {
                try {
                    const exportData = {
                        version: "1.0",
                        exportDate: new Date().toISOString(),
                        killEvents: this.killEvents,
                        testData: true
                    };
                    
                    const jsonString = JSON.stringify(exportData, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `测试_金猪监控数据_${this.formatDateForFilename(new Date())}.json`;
                    
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    return { success: true, filename: link.download };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
            
            formatDateForFilename(date) {
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${year}${month}${day}_${hours}${minutes}`;
            }
        }
        
        // 创建测试实例
        const testManager = new TestStatsManager();
        
        // 全局函数
        window.createTestData = function() {
            const count = testManager.addTestData();
            showStatus('test-data-status', `已创建 ${count} 条测试数据`, 'success');
        };
        
        window.clearTestData = function() {
            testManager.clearData();
            showStatus('test-data-status', '已清空所有测试数据', 'info');
        };
        
        window.validateData = function() {
            const results = testManager.validateData();
            const resultText = `数据验证结果:
总事件数: ${results.totalEvents}
有效时间戳: ${results.validTimestamps}
无效时间戳: ${results.invalidTimestamps}
有效线路号: ${results.validLines}
无效线路号: ${results.invalidLines}

示例事件:
${JSON.stringify(results.sampleEvents, null, 2)}`;
            
            document.getElementById('validation-result').textContent = resultText;
            document.getElementById('validation-result').style.display = 'block';
        };
        
        window.debugCSV = function() {
            try {
                const csvContent = testManager.generateCSVContent();
                const lines = csvContent.split('\\n');
                const debugText = `CSV内容调试:
总行数: ${lines.length}
标题行: ${lines[0]}
数据行示例:
${lines.slice(1, 6).join('\\n')}

完整CSV前500字符:
${csvContent.substring(0, 500)}`;
                
                document.getElementById('csv-debug-result').textContent = debugText;
                document.getElementById('csv-debug-result').style.display = 'block';
            } catch (error) {
                document.getElementById('csv-debug-result').textContent = '错误: ' + error.message;
                document.getElementById('csv-debug-result').style.display = 'block';
            }
        };
        
        window.testCSVExport = function() {
            const result = testManager.exportToCSV();
            if (result.success) {
                showStatus('export-status', `CSV导出成功！文件名: ${result.filename}`, 'success');
            } else {
                showStatus('export-status', `CSV导出失败: ${result.error}`, 'error');
            }
        };
        
        window.testJSONExport = function() {
            const result = testManager.exportToJSON();
            if (result.success) {
                showStatus('export-status', `JSON导出成功！文件名: ${result.filename}`, 'success');
            } else {
                showStatus('export-status', `JSON导出失败: ${result.error}`, 'error');
            }
        };
        
        window.checkCompatibility = function() {
            const compatibility = {
                blob: !!window.Blob,
                createObjectURL: !!(window.URL && window.URL.createObjectURL),
                download: (function() {
                    const a = document.createElement('a');
                    return 'download' in a;
                })(),
                localStorage: !!window.localStorage
            };
            
            const resultText = `浏览器兼容性检查:
Blob支持: ${compatibility.blob ? '✅' : '❌'}
URL.createObjectURL支持: ${compatibility.createObjectURL ? '✅' : '❌'}  
下载属性支持: ${compatibility.download ? '✅' : '❌'}
本地存储支持: ${compatibility.localStorage ? '✅' : '❌'}

浏览器信息:
用户代理: ${navigator.userAgent}`;
            
            document.getElementById('compatibility-result').textContent = resultText;
            document.getElementById('compatibility-result').style.display = 'block';
        };
        
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = 'status ' + type;
            element.style.display = 'block';
        }
    </script>
</body>
</html>
