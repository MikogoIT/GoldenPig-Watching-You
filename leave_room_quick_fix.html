<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>离开房间问题一键修复</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f8f9fa;
        }
        .fix-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .fix-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 200px;
        }
        .fix-btn:hover {
            background: #c0392b;
        }
        .fix-btn.primary {
            background: #3498db;
        }
        .fix-btn.primary:hover {
            background: #2980b9;
        }
        .status {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-family: monospace;
        }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .info { color: #3498db; }
    </style>
</head>
<body>
    <div class="fix-container">
        <h1>🔧 离开房间问题一键修复</h1>
        
        <div class="status" id="status">
            准备就绪，点击下面的按钮进行修复...
        </div>
        
        <div style="text-align: center;">
            <h3>🚀 推荐修复方案</h3>
            <button class="fix-btn primary" onclick="runQuickFix()">一键修复所有问题</button>
            <br>
            
            <h3>🔧 分步修复</h3>
            <button class="fix-btn" onclick="showRoomInfo()">显示房间信息框</button>
            <button class="fix-btn" onclick="fixButton()">修复离开按钮</button>
            <br>
            
            <h3>🚨 应急方案</h3>
            <button class="fix-btn" onclick="emergencyLeave()">强制离开房间</button>
        </div>
        
        <div style="margin-top: 30px;">
            <h3>📋 问题说明</h3>
            <ul>
                <li><strong>问题1:</strong> 显示了模态对话框而不是悬浮房间信息框</li>
                <li><strong>原因:</strong> showCollaborationDialog方法没有检查当前房间状态</li>
                <li><strong>修复:</strong> 已修改方法，当用户在房间中时直接显示房间信息框</li>
            </ul>
            <ul>
                <li><strong>问题2:</strong> 离开房间按钮点击失败</li>
                <li><strong>原因:</strong> 事件监听器绑定问题或CSS样式覆盖</li>
                <li><strong>修复:</strong> 重新绑定事件监听器并应用强制样式</li>
            </ul>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 5px;">
            <h4>⚠️ 使用说明</h4>
            <ol>
                <li>确保主页面已打开并加入了房间</li>
                <li>点击"一键修复所有问题"按钮</li>
                <li>如果问题仍存在，尝试"强制离开房间"</li>
                <li>刷新页面后重新加入房间</li>
            </ol>
        </div>
    </div>

    <script>
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            console.log(message);
        }
        
        function runQuickFix() {
            updateStatus('正在执行一键修复...', 'info');
            
            try {
                // 检查是否能访问主页面
                if (!window.opener && !window.parent.app) {
                    updateStatus('❌ 无法访问主页面，请确保从主页面打开此页面', 'error');
                    return;
                }
                
                const app = window.opener?.app || window.parent.app;
                if (!app || !app.firebaseManager) {
                    updateStatus('❌ 无法访问FirebaseManager，请确保主页面已加载', 'error');
                    return;
                }
                
                const fm = app.firebaseManager;
                
                // 1. 检查是否在房间中
                if (!fm.roomId) {
                    updateStatus('❌ 当前没有加入任何房间', 'error');
                    return;
                }
                
                updateStatus('✅ 检测到用户在房间中: ' + fm.roomId, 'success');
                
                // 2. 强制显示房间信息框
                updateStatus('🏠 显示房间信息框...', 'info');
                fm.showRoomInfo();
                
                // 3. 等待DOM更新后修复按钮
                setTimeout(() => {
                    updateStatus('🔧 修复离开房间按钮...', 'info');
                    
                    const leaveBtn = (window.opener || window.parent).document.getElementById('leave-room-btn');
                    if (leaveBtn) {
                        // 重新绑定事件
                        const newBtn = leaveBtn.cloneNode(true);
                        leaveBtn.parentNode.replaceChild(newBtn, leaveBtn);
                        
                        newBtn.addEventListener('click', async (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            if (confirm('确定要离开房间吗？')) {
                                newBtn.disabled = true;
                                newBtn.textContent = '离开中...';
                                
                                try {
                                    await fm.leaveRoom();
                                    updateStatus('✅ 成功离开房间', 'success');
                                } catch (error) {
                                    console.error('离开失败:', error);
                                    updateStatus('❌ 离开失败: ' + error.message, 'error');
                                    newBtn.disabled = false;
                                    newBtn.textContent = '离开房间';
                                }
                            }
                        });
                        
                        // 应用样式
                        newBtn.style.cssText = `
                            background: #e74c3c !important;
                            color: white !important;
                            border: none !important;
                            padding: 8px 12px !important;
                            border-radius: 5px !important;
                            cursor: pointer !important;
                            font-size: 13px !important;
                            font-weight: bold !important;
                            opacity: 1 !important;
                            pointer-events: auto !important;
                        `;
                        
                        updateStatus('✅ 一键修复完成！房间信息框已显示，离开按钮已修复', 'success');
                    } else {
                        updateStatus('⚠️ 未找到离开按钮，可能需要手动刷新', 'error');
                    }
                }, 500);
                
            } catch (error) {
                console.error('修复失败:', error);
                updateStatus('❌ 修复失败: ' + error.message, 'error');
            }
        }
        
        function showRoomInfo() {
            updateStatus('显示房间信息框...', 'info');
            
            try {
                const app = window.opener?.app || window.parent.app;
                if (app && app.firebaseManager && app.firebaseManager.roomId) {
                    app.firebaseManager.showRoomInfo();
                    updateStatus('✅ 房间信息框已显示', 'success');
                } else {
                    updateStatus('❌ 无法访问FirebaseManager或用户不在房间中', 'error');
                }
            } catch (error) {
                updateStatus('❌ 显示失败: ' + error.message, 'error');
            }
        }
        
        function fixButton() {
            updateStatus('修复离开按钮...', 'info');
            
            try {
                const targetWindow = window.opener || window.parent;
                const leaveBtn = targetWindow.document.getElementById('leave-room-btn');
                
                if (leaveBtn) {
                    // 强制样式
                    leaveBtn.style.cssText = `
                        background: #e74c3c !important;
                        color: white !important;
                        border: none !important;
                        padding: 8px 12px !important;
                        border-radius: 5px !important;
                        cursor: pointer !important;
                        font-size: 13px !important;
                        opacity: 1 !important;
                        pointer-events: auto !important;
                        z-index: 10001 !important;
                    `;
                    
                    updateStatus('✅ 离开按钮样式已修复', 'success');
                } else {
                    updateStatus('❌ 未找到离开按钮', 'error');
                }
            } catch (error) {
                updateStatus('❌ 修复失败: ' + error.message, 'error');
            }
        }
        
        function emergencyLeave() {
            updateStatus('执行应急离开...', 'info');
            
            if (confirm('确定要强制离开房间吗？这将清理所有本地状态。')) {
                try {
                    const app = window.opener?.app || window.parent.app;
                    if (app && app.firebaseManager) {
                        const fm = app.firebaseManager;
                        
                        // 强制清理
                        if (fm.stopHeartbeat) fm.stopHeartbeat();
                        if (fm.removeRoomListeners) fm.removeRoomListeners();
                        
                        fm.roomId = null;
                        fm.isHost = false;
                        fm.roomRef = null;
                        fm.usersRef = null;
                        fm.gameStateRef = null;
                        
                        // 隐藏房间信息框
                        const roomInfo = (window.opener || window.parent).document.getElementById('room-info');
                        if (roomInfo) roomInfo.remove();
                        
                        // 清理本地存储
                        localStorage.removeItem('firebase_collaboration_roomId');
                        localStorage.removeItem('firebase_collaboration_isHost');
                        
                        updateStatus('✅ 应急离开完成', 'success');
                    } else {
                        updateStatus('❌ 无法访问FirebaseManager', 'error');
                    }
                } catch (error) {
                    updateStatus('❌ 应急离开失败: ' + error.message, 'error');
                }
            }
        }
        
        // 页面加载时检查状态
        window.addEventListener('load', () => {
            try {
                const app = window.opener?.app || window.parent.app;
                if (app && app.firebaseManager) {
                    const fm = app.firebaseManager;
                    if (fm.roomId) {
                        updateStatus(`检测到用户在房间中: ${fm.roomId}，可以开始修复`, 'success');
                    } else {
                        updateStatus('用户当前没有加入房间', 'info');
                    }
                } else {
                    updateStatus('无法访问主页面，请确保从主页面打开此修复工具', 'error');
                }
            } catch (error) {
                updateStatus('页面加载检查失败: ' + error.message, 'error');
            }
        });
    </script>
</body>
</html>
