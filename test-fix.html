<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>金猪监控系统 - 问题验证测试</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #2c3e50; 
            color: white; 
        }
        .test-container { 
            display: grid; 
            grid-template-columns: 300px 1fr; 
            gap: 20px; 
            margin: 20px 0; 
        }
        .controls { 
            background: rgba(0,0,0,0.5); 
            padding: 20px; 
            border-radius: 10px; 
        }
        .test-grid { 
            display: grid; 
            grid-template-columns: repeat(10, 50px); 
            gap: 5px; 
            margin: 10px 0; 
        }
        .test-cell { 
            width: 50px; 
            height: 50px; 
            border: 1px solid #ccc; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            cursor: pointer; 
            position: relative;
            background: linear-gradient(to bottom right, #34495e, #2c3e50);
            color: white;
            border-radius: 5px;
            font-weight: bold;
        }
        .test-cell.killed { 
            background: linear-gradient(to bottom right, #e74c3c, #c0392b); 
        }
        .test-cell.killed-unknown { 
            background: linear-gradient(to bottom right, #e67e22, #d35400); 
        }
        .test-cell.refreshed { 
            background: linear-gradient(to bottom right, #2ecc71, #27ae60); 
        }
        .timer-display { 
            position: absolute; 
            bottom: 2px; 
            left: 2px; 
            right: 2px; 
            font-size: 8px; 
            background: rgba(0,0,0,0.8); 
            color: white; 
            border-radius: 2px; 
            padding: 1px; 
            text-align: center; 
        }
        .stats { 
            background: rgba(0,0,0,0.3); 
            padding: 15px; 
            border-radius: 10px; 
            margin: 10px 0; 
        }
        .stat-item { 
            display: flex; 
            justify-content: space-between; 
            margin: 5px 0; 
        }
        .log { 
            background: #1a1a1a; 
            padding: 10px; 
            margin: 10px 0; 
            height: 150px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 11px; 
            border-radius: 5px;
        }
        button { 
            margin: 5px 0; 
            padding: 8px 12px; 
            background: #3498db; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            width: 100%;
        }
        button:hover { background: #2980b9; }
        .test-mode { background: #e67e22; }
        .test-mode:hover { background: #d35400; }
    </style>
</head>
<body>
    <h1>🐷 金猪监控系统 - 问题验证测试</h1>
    
    <div class="test-container">
        <div class="controls">
            <h3>📊 实时统计</h3>
            <div class="stats">
                <div class="stat-item">
                    <span>击杀中:</span>
                    <span id="test-killed">0</span>
                </div>
                <div class="stat-item">
                    <span>未知时间:</span>
                    <span id="test-unknown">0</span>
                </div>
                <div class="stat-item">
                    <span>已刷新:</span>
                    <span id="test-refreshed">0</span>
                </div>
                <div class="stat-item">
                    <span>可用:</span>
                    <span id="test-available">20</span>
                </div>
                <div class="stat-item">
                    <span><strong>今日击杀:</strong></span>
                    <span id="test-today"><strong>0</strong></span>
                </div>
            </div>
            
            <h3>🎮 测试控制</h3>
            <button onclick="toggleTestMode()" id="test-mode-btn">开启测试模式 (10秒)</button>
            <button onclick="clearAllData()">清除所有数据</button>
            <button onclick="refreshStats()">刷新统计</button>
            <button onclick="showKillEvents()">显示击杀事件</button>
            
            <h3>📝 操作日志</h3>
            <div class="log" id="test-log"></div>
            <button onclick="clearLog()">清除日志</button>
        </div>
        
        <div>
            <h3>🎯 测试网格 (前20个线路)</h3>
            <p><strong>操作说明:</strong></p>
            <ul>
                <li>左键 = 击杀 (红色 + 倒计时)</li>
                <li>右键 = 击杀未知时间 (橙色)</li>
                <li>双击 = 取消状态</li>
            </ul>
            <div class="test-grid" id="test-grid"></div>
        </div>
    </div>

    <script type="module">
        import { GAME_CONFIG } from './js/config.js';
        import { TimerManager } from './js/modules/timerManager.js';
        import { StatsManager } from './js/modules/statsManager.js';
        import { StorageManager } from './js/modules/storageManager.js';
        import { AnimationManager } from './js/modules/animationManager.js';
        import { UIManager } from './js/modules/uiManager.js';
        import { EventManager } from './js/modules/eventManager.js';

        // 全局状态
        let testMode = false;
        let managers = {};

        // 初始化管理器
        function initManagers() {
            try {
                managers.storage = new StorageManager();
                managers.stats = new StatsManager();
                managers.animation = new AnimationManager();
                managers.ui = new UIManager();
                managers.timer = new TimerManager(managers.storage);
                managers.event = new EventManager(
                    managers.timer, 
                    managers.stats, 
                    managers.animation, 
                    managers.ui, 
                    managers.storage
                );
                
                log('✅ 所有管理器初始化成功');
                
                // 确保统计管理器元素绑定
                setTimeout(() => {
                    managers.stats.bindElements();
                    log('✅ 统计管理器元素绑定完成');
                }, 100);
                
            } catch (error) {
                log(`❌ 管理器初始化失败: ${error.message}`);
            }
        }

        // 日志函数
        function log(message) {
            const logDiv = document.getElementById('test-log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[TEST] ${message}`);
        }

        // 创建测试网格
        function createTestGrid() {
            const grid = document.getElementById('test-grid');
            for (let i = 1; i <= 20; i++) {
                const cell = document.createElement('div');
                cell.className = 'test-cell';
                cell.dataset.line = i;
                cell.textContent = i;
                
                // 添加定时器显示
                const timer = document.createElement('div');
                timer.id = `timer-${i}`;
                timer.className = 'timer-display';
                cell.appendChild(timer);
                
                // 绑定事件
                cell.addEventListener('click', (e) => {
                    log(`🖱️ 左键点击线路 ${i}`);
                    if (managers.event) {
                        managers.event.handleCellClick(e);
                        setTimeout(updateTestStats, 100);
                    }
                });
                
                cell.addEventListener('contextmenu', (e) => {
                    log(`👆 右键点击线路 ${i}`);
                    if (managers.event) {
                        managers.event.handleCellRightClick(e);
                        setTimeout(updateTestStats, 100);
                    }
                });
                
                cell.addEventListener('dblclick', (e) => {
                    log(`🔄 双击线路 ${i}`);
                    if (managers.event) {
                        managers.event.handleCellDoubleClick(e);
                        setTimeout(updateTestStats, 100);
                    }
                });
                
                grid.appendChild(cell);
            }
            log('🎯 测试网格创建完成');
        }

        // 更新测试统计
        function updateTestStats() {
            const cells = document.querySelectorAll('.test-cell');
            let killed = 0, unknown = 0, refreshed = 0, available = 0;
            
            cells.forEach(cell => {
                if (cell.classList.contains('killed')) killed++;
                else if (cell.classList.contains('killed-unknown')) unknown++;
                else if (cell.classList.contains('refreshed')) refreshed++;
                else available++;
            });
            
            document.getElementById('test-killed').textContent = killed;
            document.getElementById('test-unknown').textContent = unknown;
            document.getElementById('test-refreshed').textContent = refreshed;
            document.getElementById('test-available').textContent = available;
            
            // 获取今日击杀数
            if (managers.stats) {
                const todayCount = managers.stats.getTodayKillCount();
                document.getElementById('test-today').textContent = todayCount;
                log(`📊 统计更新: 击杀=${killed}, 未知=${unknown}, 刷新=${refreshed}, 可用=${available}, 今日=${todayCount}`);
            }
        }

        // 全局函数
        window.toggleTestMode = function() {
            testMode = !testMode;
            if (managers.timer) {
                managers.timer.setTestMode(testMode);
            }
            const btn = document.getElementById('test-mode-btn');
            if (testMode) {
                btn.textContent = '关闭测试模式 (24小时)';
                btn.className = 'test-mode';
            } else {
                btn.textContent = '开启测试模式 (10秒)';
                btn.className = '';
            }
            log(`🧪 测试模式: ${testMode ? '开启 (10秒倒计时)' : '关闭 (24小时倒计时)'}`);
        };

        window.clearAllData = function() {
            // 清除格子状态
            document.querySelectorAll('.test-cell').forEach(cell => {
                cell.className = 'test-cell';
                const timer = cell.querySelector('.timer-display');
                if (timer) timer.textContent = '';
            });
            
            // 清除存储和计时器
            localStorage.clear();
            if (managers.timer) managers.timer.clearAllTimers();
            if (managers.stats) {
                managers.stats.killEvents = [];
                managers.stats.bindElements();
            }
            
            updateTestStats();
            log('🗑️ 所有数据已清除');
        };

        window.refreshStats = function() {
            if (managers.stats) {
                managers.stats.updateStats();
            }
            updateTestStats();
            log('🔄 统计已刷新');
        };

        window.showKillEvents = function() {
            if (managers.stats) {
                const events = managers.stats.killEvents;
                log(`📋 击杀事件列表 (${events.length}个):`);
                events.forEach((event, index) => {
                    const time = new Date(event.timestamp).toLocaleString();
                    log(`  ${index + 1}. 线路${event.line} - ${time}`);
                });
            }
        };

        window.clearLog = function() {
            document.getElementById('test-log').innerHTML = '';
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('🚀 页面加载完成，开始初始化...');
            initManagers();
            createTestGrid();
            setTimeout(() => {
                updateTestStats();
                log('✅ 测试系统就绪');
            }, 200);
        });
    </script>
</body>
</html>
