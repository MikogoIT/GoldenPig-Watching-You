<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase连接测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .console {
            background: #1e1e1e;
            color: #ffffff;
            padding: 20px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .instructions {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔥 Firebase连接测试</h1>
        
        <div class="instructions">
            <h3>📋 测试前请确认：</h3>
            <ol>
                <li>✅ 已在Firebase控制台启用<strong>匿名认证</strong></li>
                <li>✅ 已配置<strong>Realtime Database安全规则</strong></li>
                <li>✅ 网络连接正常</li>
            </ol>
            <p>🔧 如果测试失败，请查看 <code>FIREBASE_DEBUG.md</code> 文件获取详细解决方案。</p>
        </div>
        
        <div>
            <button onclick="testFirebaseConnection()">🧪 开始测试</button>
            <button onclick="clearConsole()">🗑️ 清空控制台</button>
        </div>
        
        <div id="console" class="console">
            控制台输出将显示在这里...
        </div>
    </div>

    <!-- Firebase v9+ SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
        import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

        // 你的Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyBgbodFry-hFl_tiWK9CAYzZ_4FFizc3kE",
            authDomain: "pig-timer-collaboration.firebaseapp.com",
            databaseURL: "https://pig-timer-collaboration-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pig-timer-collaboration",
            storageBucket: "pig-timer-collaboration.firebasestorage.app",
            messagingSenderId: "629352460916",
            appId: "1:629352460916:web:248d4051b64d8cb4e51721",
            measurementId: "G-5RMRLLTTRP"
        };

        // 控制台输出函数
        function logToConsole(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#ffffff',
                success: '#4caf50',
                error: '#f44336',
                warning: '#ff9800'
            };
            
            console.innerHTML += `<div style="color: ${colors[type]}; margin: 5px 0;">${timestamp} - ${message}</div>`;
            console.scrollTop = console.scrollHeight;
            
            // 同时输出到浏览器控制台
            if (type === 'error') {
                console.error(`${timestamp} - ${message}`);
            } else {
                console.log(`${timestamp} - ${message}`);
            }
        }

        // 测试Firebase连接
        async function testFirebaseConnection() {
            logToConsole('🔄 开始Firebase连接测试...', 'info');
            
            try {
                // 步骤1：初始化Firebase应用
                logToConsole('📱 初始化Firebase应用...', 'info');
                const app = initializeApp(firebaseConfig);
                logToConsole('✅ Firebase应用初始化成功', 'success');
                
                // 步骤2：获取认证和数据库实例
                const auth = getAuth(app);
                const database = getDatabase(app);
                logToConsole('🔧 获取Firebase服务实例成功', 'success');
                
                // 步骤3：匿名登录
                logToConsole('🔐 开始匿名用户认证...', 'info');
                const userCredential = await signInAnonymously(auth);
                const user = userCredential.user;
                logToConsole(`✅ 匿名登录成功，用户ID: ${user.uid.substring(0, 8)}...`, 'success');
                
                // 步骤4：测试数据库连接状态
                logToConsole('🌐 测试数据库连接状态...', 'info');
                const connectionRef = ref(database, '.info/connected');
                
                onValue(connectionRef, (snapshot) => {
                    const connected = snapshot.val();
                    if (connected) {
                        logToConsole('✅ Firebase Realtime Database连接成功', 'success');
                        
                        // 步骤5：测试数据库读写权限
                        testDatabasePermissions(database, user.uid);
                    } else {
                        logToConsole('❌ Firebase Realtime Database连接失败', 'error');
                        logToConsole('💡 请检查网络连接和Firebase项目状态', 'warning');
                    }
                });
                
            } catch (error) {
                logToConsole(`❌ Firebase连接失败: ${error.code} - ${error.message}`, 'error');
                
                // 提供具体的错误解决建议
                if (error.code === 'auth/invalid-api-key') {
                    logToConsole('🔧 解决方案: 检查Firebase配置中的API密钥是否正确', 'warning');
                } else if (error.code === 'auth/network-request-failed') {
                    logToConsole('🔧 解决方案: 检查网络连接，可能需要科学上网', 'warning');
                } else if (error.code === 'auth/operation-not-allowed') {
                    logToConsole('🔧 解决方案: 需要在Firebase控制台启用匿名认证', 'warning');
                    logToConsole('📖 详细步骤: Authentication → 登录方法 → 匿名 → 启用', 'warning');
                } else if (error.message.includes('Invalid token in path')) {
                    logToConsole('🔧 解决方案: 需要启用匿名认证并配置数据库安全规则', 'warning');
                    logToConsole('📖 详细步骤请查看 FIREBASE_DEBUG.md 文件', 'warning');
                } else {
                    logToConsole('🔧 通用解决方案: 检查Firebase项目配置和网络连接', 'warning');
                }
            }
        }
        
        // 测试数据库权限
        async function testDatabasePermissions(database, userId) {
            try {
                logToConsole('📝 测试数据库写入权限...', 'info');
                
                const testData = {
                    userId: userId,
                    timestamp: Date.now(),
                    message: 'Firebase权限测试',
                    testType: 'connection_test'
                };
                
                const testRef = ref(database, `test/${userId}`);
                await set(testRef, testData);
                logToConsole('✅ 数据库写入权限测试成功', 'success');
                
                // 测试读取权限
                logToConsole('📖 测试数据库读取权限...', 'info');
                const snapshot = await get(testRef);
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    logToConsole('✅ 数据库读取权限测试成功', 'success');
                    logToConsole(`📄 读取到的数据: ${JSON.stringify(data)}`, 'info');
                    logToConsole('🎉 Firebase完全配置成功！可以开始使用多人协作功能。', 'success');
                } else {
                    logToConsole('⚠️ 数据库读取测试失败：数据不存在', 'warning');
                }
                
            } catch (error) {
                logToConsole(`❌ 数据库操作失败: ${error.code} - ${error.message}`, 'error');
                
                if (error.code === 'PERMISSION_DENIED' || error.message.includes('permission-denied')) {
                    logToConsole('🔧 解决方案: 数据库安全规则不允许当前用户操作', 'warning');
                    logToConsole('📖 请按照 FIREBASE_DEBUG.md 中的步骤配置安全规则', 'warning');
                    logToConsole('⚡ 临时解决方案: 在数据库规则中设置 ".read": true, ".write": true', 'warning');
                }
            }
        }
        
        // 清空控制台
        function clearConsole() {
            document.getElementById('console').innerHTML = '控制台已清空，准备新的测试...';
        }
        
        // 将函数暴露到全局作用域
        window.testFirebaseConnection = testFirebaseConnection;
        window.clearConsole = clearConsole;
        
        // 页面加载完成后自动运行一次测试
        window.addEventListener('load', () => {
            logToConsole('🚀 Firebase测试页面已加载', 'success');
            logToConsole('👆 点击"开始测试"按钮开始检测Firebase连接状态', 'info');
        });
    </script>
</body>
</html>
