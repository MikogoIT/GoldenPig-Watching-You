<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase详细调试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .error-section {
            background: #fff5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #dc3545;
        }
        .success-section {
            background: #f0f8f0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #28a745;
        }
        .console {
            background: #1e1e1e;
            color: #ffffff;
            padding: 20px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 500px;
            overflow-y: auto;
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .step {
            background: #e3f2fd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Firebase详细调试工具</h1>
        
        <div class="debug-section">
            <h3>🎯 当前配置信息</h3>
            <pre id="config-info">正在检查配置...</pre>
        </div>
        
        <div>
            <button onclick="step1_checkEnvironment()">步骤1: 检查环境</button>
            <button onclick="step2_testFirebaseSDK()">步骤2: 测试Firebase SDK</button>
            <button onclick="step3_testAuth()">步骤3: 测试认证</button>
            <button onclick="step4_testDatabase()">步骤4: 测试数据库</button>
            <button onclick="runAllSteps()">🚀 运行所有步骤</button>
            <button onclick="clearConsole()">🗑️ 清空</button>
        </div>
        
        <div id="console" class="console">
            准备开始Firebase详细调试...
        </div>

        <div class="debug-section">
            <h3>📋 手动检查清单</h3>
            <div class="step">
                <strong>1. 检查Authentication设置</strong><br>
                访问: <a href="https://console.firebase.google.com/project/pig-timer-collaboration/authentication/providers" target="_blank">Authentication → 登录方法</a><br>
                确保"匿名"提供商已启用
            </div>
            <div class="step">
                <strong>2. 检查Realtime Database规则</strong><br>
                访问: <a href="https://console.firebase.google.com/project/pig-timer-collaboration/database/pig-timer-collaboration-default-rtdb/rules" target="_blank">Realtime Database → 规则</a><br>
                设置为: <code>{ "rules": { ".read": true, ".write": true } }</code>
            </div>
            <div class="step">
                <strong>3. 检查网络连接</strong><br>
                确保可以访问: <code>https://firebase.googleapis.com</code>
            </div>
        </div>
    </div>

    <script type="module">
        // 使用你截图中显示的完整配置
        const firebaseConfig = {
            apiKey: "AIzaSyBgbodFry-hFl_tiWK9CAYzZ_4FFizc3kE",
            authDomain: "pig-timer-collaboration.firebaseapp.com",
            databaseURL: "https://pig-timer-collaboration-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pig-timer-collaboration",
            storageBucket: "pig-timer-collaboration.firebasestorage.app",
            messagingSenderId: "629352460916",
            appId: "1:629352460916:web:248d4051b64d8cb4e51721",
            measurementId: "G-5RMRLLTTRP"
        };

        let globalApp, globalAuth, globalDatabase;

        // 显示配置信息
        document.getElementById('config-info').textContent = JSON.stringify(firebaseConfig, null, 2);

        // 控制台输出函数
        function logToConsole(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#ffffff',
                success: '#4caf50',
                error: '#f44336',
                warning: '#ff9800',
                debug: '#9c27b0'
            };
            
            console.innerHTML += `<div style="color: ${colors[type]}; margin: 3px 0;">[${timestamp}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }

        // 步骤1: 检查环境
        async function step1_checkEnvironment() {
            logToConsole('=== 步骤1: 检查环境 ===', 'debug');
            
            // 检查浏览器
            logToConsole(`浏览器: ${navigator.userAgent}`, 'info');
            logToConsole(`当前URL: ${window.location.href}`, 'info');
            
            // 检查网络连接
            try {
                const response = await fetch('https://www.googleapis.com/firebase/v1beta1/projects/pig-timer-collaboration');
                logToConsole('✅ Firebase API可访问', 'success');
            } catch (error) {
                logToConsole(`❌ Firebase API访问失败: ${error.message}`, 'error');
                logToConsole('💡 可能需要科学上网工具', 'warning');
            }
            
            // 检查CDN连接
            try {
                const response = await fetch('https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js', { method: 'HEAD' });
                logToConsole('✅ Firebase CDN可访问', 'success');
            } catch (error) {
                logToConsole(`❌ Firebase CDN访问失败: ${error.message}`, 'error');
            }
        }

        // 步骤2: 测试Firebase SDK
        async function step2_testFirebaseSDK() {
            logToConsole('=== 步骤2: 测试Firebase SDK ===', 'debug');
            
            try {
                // 动态导入Firebase模块
                logToConsole('正在导入Firebase模块...', 'info');
                
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js');
                const { getAuth, signInAnonymously, connectAuthEmulator } = await import('https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js');
                const { getDatabase, ref, set, get, connectDatabaseEmulator } = await import('https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js');
                
                logToConsole('✅ Firebase模块导入成功', 'success');
                
                // 初始化Firebase应用
                logToConsole('正在初始化Firebase应用...', 'info');
                globalApp = initializeApp(firebaseConfig);
                logToConsole('✅ Firebase应用初始化成功', 'success');
                
                // 获取服务实例
                globalAuth = getAuth(globalApp);
                globalDatabase = getDatabase(globalApp);
                logToConsole('✅ Firebase服务实例创建成功', 'success');
                
                window.firebaseServices = { globalApp, globalAuth, globalDatabase, signInAnonymously, ref, set, get };
                
            } catch (error) {
                logToConsole(`❌ Firebase SDK加载失败: ${error.message}`, 'error');
                logToConsole(`错误堆栈: ${error.stack}`, 'error');
            }
        }

        // 步骤3: 测试认证
        async function step3_testAuth() {
            logToConsole('=== 步骤3: 测试认证 ===', 'debug');
            
            if (!globalAuth) {
                logToConsole('❌ 请先运行步骤2', 'error');
                return;
            }
            
            try {
                logToConsole('正在尝试匿名登录...', 'info');
                
                const { signInAnonymously } = window.firebaseServices;
                const userCredential = await signInAnonymously(globalAuth);
                const user = userCredential.user;
                
                logToConsole(`✅ 匿名登录成功!`, 'success');
                logToConsole(`用户ID: ${user.uid}`, 'info');
                logToConsole(`是否匿名: ${user.isAnonymous}`, 'info');
                
                window.currentUser = user;
                
            } catch (error) {
                logToConsole(`❌ 匿名登录失败: ${error.code} - ${error.message}`, 'error');
                
                if (error.code === 'auth/operation-not-allowed') {
                    logToConsole('🔧 解决方案: 需要在Firebase控制台启用匿名认证', 'warning');
                    logToConsole('📖 路径: Authentication → 登录方法 → 匿名 → 启用', 'warning');
                } else if (error.code === 'auth/network-request-failed') {
                    logToConsole('🔧 解决方案: 检查网络连接', 'warning');
                } else {
                    logToConsole(`🔧 错误代码解释: ${error.code}`, 'warning');
                }
            }
        }

        // 步骤4: 测试数据库
        async function step4_testDatabase() {
            logToConsole('=== 步骤4: 测试数据库 ===', 'debug');
            
            if (!globalDatabase || !window.currentUser) {
                logToConsole('❌ 请先完成步骤2和步骤3', 'error');
                return;
            }
            
            try {
                const { ref, set, get } = window.firebaseServices;
                const userId = window.currentUser.uid;
                
                // 测试写入
                logToConsole('正在测试数据库写入...', 'info');
                const testRef = ref(globalDatabase, `debug_test/${userId}`);
                const testData = {
                    timestamp: Date.now(),
                    message: 'Firebase调试测试',
                    randomValue: Math.random()
                };
                
                await set(testRef, testData);
                logToConsole('✅ 数据库写入成功', 'success');
                
                // 测试读取
                logToConsole('正在测试数据库读取...', 'info');
                const snapshot = await get(testRef);
                
                if (snapshot.exists()) {
                    logToConsole('✅ 数据库读取成功', 'success');
                    logToConsole(`读取的数据: ${JSON.stringify(snapshot.val())}`, 'info');
                    logToConsole('🎉 Firebase完全正常工作！', 'success');
                } else {
                    logToConsole('⚠️ 数据库读取失败: 数据不存在', 'warning');
                }
                
            } catch (error) {
                logToConsole(`❌ 数据库操作失败: ${error.code} - ${error.message}`, 'error');
                
                if (error.code === 'PERMISSION_DENIED' || error.message.includes('permission-denied')) {
                    logToConsole('🔧 解决方案: 数据库安全规则问题', 'warning');
                    logToConsole('📖 设置规则为: { "rules": { ".read": true, ".write": true } }', 'warning');
                } else if (error.message.includes('Invalid token in path')) {
                    logToConsole('🔧 解决方案: 认证token无效，可能是规则配置问题', 'warning');
                }
            }
        }

        // 运行所有步骤
        async function runAllSteps() {
            logToConsole('🚀 开始完整的Firebase调试流程...', 'debug');
            
            await step1_checkEnvironment();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await step2_testFirebaseSDK();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await step3_testAuth();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await step4_testDatabase();
            
            logToConsole('🏁 调试流程完成', 'debug');
        }

        // 清空控制台
        function clearConsole() {
            document.getElementById('console').innerHTML = '控制台已清空...';
        }

        // 暴露函数到全局
        window.step1_checkEnvironment = step1_checkEnvironment;
        window.step2_testFirebaseSDK = step2_testFirebaseSDK;
        window.step3_testAuth = step3_testAuth;
        window.step4_testDatabase = step4_testDatabase;
        window.runAllSteps = runAllSteps;
        window.clearConsole = clearConsole;

        // 页面加载完成后的提示
        window.addEventListener('load', () => {
            logToConsole('🔧 Firebase详细调试工具已准备就绪', 'success');
            logToConsole('💡 建议点击"运行所有步骤"进行完整测试', 'info');
        });
    </script>
</body>
</html>
